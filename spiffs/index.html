<!DOCTYPE html>
<html>
<head>
    <title>Power Consumption Monitor</title>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f0f0; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .sensor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .sensor-section { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef; }
        .sensor-section h3 { margin-top: 0; margin-bottom: 15px; color: #495057; text-align: center; }
        .sensor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 10px 0; }
        .sensor-card { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sensor-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .sensor-unit { font-size: 14px; color: #666; }
        .sensor-label { font-size: 16px; color: #333; margin-bottom: 5px; }
        .raw-data { background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .raw-data h3 { margin-top: 0; color: #495057; }
        .raw-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .raw-section { background: white; padding: 15px; border-radius: 8px; }
        .raw-section h4 { margin-top: 0; margin-bottom: 10px; color: #495057; text-align: center; }
        .raw-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .raw-item { background: white; padding: 10px; border-radius: 5px; text-align: center; }
        .timestamp { text-align: center; color: #666; font-size: 14px; margin-top: 20px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        .btn.success { background: #28a745; }
        .btn.success:hover { background: #218838; }
        .status { text-align: center; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .logging-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .logging-panel h3 { margin-top: 0; color: #495057; }
        .log-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .log-item { background: white; padding: 10px; border-radius: 5px; }
        .log-item label { font-weight: bold; color: #495057; }
        .log-item span { color: #666; }
        .refresh-rate { margin: 10px 0; text-align: center; }
        .refresh-rate select { padding: 5px; border-radius: 3px; }
        .config-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .config-panel h3 { margin-top: 0; color: #495057; }
        .config-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; color: #495057; margin-bottom: 5px; }
        .form-group input, .form-group select { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
        .config-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.warning:hover { background: #e0a800; }
        .btn.danger { background: #dc3545; color: white; font-weight: bold; }
        .btn.danger:hover { background: #c82333; }
        
        /* Responsive design for mobile devices */
        @media (max-width: 768px) {
            .sensor-container { grid-template-columns: 1fr; }
            .raw-sections { grid-template-columns: 1fr; }
            .sensor-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .raw-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
            .container { margin: 10px; padding: 15px; }
        }
    </style>
</head>
<body>
        <div class='container'>
        <h1>🔌 Power Consumption Monitor</h1>
        </div>
        <div id='wifi-status' class='status'>Loading WiFi status...</div>
        <div id='status' class='status'>Loading...</div>
        <div class='sensor-container'>
            <div class='sensor-section'>
                <h3>🔌 Sensor 1 (INA219 #1)</h3>
                <div class='sensor-grid'> 
                    <div class='sensor-card'>
                        <div class='sensor-label'>Bus Voltage</div>
                        <div class='sensor-value' id='sensor1-bus-voltage'>--</div>
                        <div class='sensor-unit'>Volts</div>
                    </div>
                    <div class='sensor-card'>
                        <div class='sensor-label'>Shunt Voltage</div>
                        <div class='sensor-value' id='sensor1-shunt-voltage'>--</div>
                        <div class='sensor-unit'>Millivolts</div>
                    </div>
                    <div class='sensor-card'>
                        <div class='sensor-label'>Current</div>
                        <div class='sensor-value' id='sensor1-current'>--</div>
                        <div class='sensor-unit'>Milliamps</div>
                    </div>
                    <div class='sensor-card'>
                        <div class='sensor-label'>Power</div>
                        <div class='sensor-value' id='sensor1-power'>--</div>
                        <div class='sensor-unit'>Milliwatts</div>
                    </div>
                </div>
            </div>
            
            <div class='sensor-section'>
                <h3>🔌 Sensor 2 (INA219 #2)</h3>
                <div class='sensor-grid'> 
                    <div class='sensor-card'>
                        <div class='sensor-label'>Bus Voltage</div>
                        <div class='sensor-value' id='sensor2-bus-voltage'>--</div>
                        <div class='sensor-unit'>Volts</div>
                    </div>
                    <div class='sensor-card'>
                        <div class='sensor-label'>Shunt Voltage</div>
                        <div class='sensor-value' id='sensor2-shunt-voltage'>--</div>
                        <div class='sensor-unit'>Millivolts</div>
                    </div>
                    <div class='sensor-card'>
                        <div class='sensor-label'>Current</div>
                        <div class='sensor-value' id='sensor2-current'>--</div>
                        <div class='sensor-unit'>Milliamps</div>
                    </div>
                    <div class='sensor-card'>
                        <div class='sensor-label'>Power</div>
                        <div class='sensor-value' id='sensor2-power'>--</div>
                        <div class='sensor-unit'>Milliwatts</div>
                    </div>
                </div>
            </div>
        </div>
        <div class='raw-data'>
            <h3>Raw Sensor Data</h3>
            <div class='raw-sections'>
                <div class='raw-section'>
                    <h4>Sensor 1 Raw Data</h4>
                    <div class='raw-grid'>
                        <div class='raw-item'>
                            <div>Bus Raw</div>
                            <div id='sensor1-raw-bus'>--</div>
                        </div>
                        <div class='raw-item'>
                            <div>Shunt Raw</div>
                            <div id='sensor1-raw-shunt'>--</div>
                        </div>
                        <div class='raw-item'>
                            <div>Current Raw</div>
                            <div id='sensor1-raw-current'>--</div>
                        </div>
                        <div class='raw-item'>
                            <div>Power Raw</div>
                            <div id='sensor1-raw-power'>--</div>
                        </div>
                    </div>
                </div>
                
                <div class='raw-section'>
                    <h4>Sensor 2 Raw Data</h4>
                    <div class='raw-grid'>
                        <div class='raw-item'>
                            <div>Bus Raw</div>
                            <div id='sensor2-raw-bus'>--</div>
                        </div>
                        <div class='raw-item'>
                            <div>Shunt Raw</div>
                            <div id='sensor2-raw-shunt'>--</div>
                        </div>
                        <div class='raw-item'>
                            <div>Current Raw</div>
                            <div id='sensor2-raw-current'>--</div>
                        </div>
                        <div class='raw-item'>
                            <div>Power Raw</div>
                            <div id='sensor2-raw-power'>--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class='logging-panel'>
            <h3>📊 Data Logging</h3>
            <div class='log-info'>
                <div class='log-item'>
                    <label>Status:</label> <span id='log-status'>Unknown</span>
                </div>
                <div class='log-item'>
                    <label>File:</label> <span id='log-filename'>--</span>
                </div>
                <div class='log-item'>
                    <label>Size:</label> <span id='log-size'>--</span>
                </div>
            </div>
            <div class='controls'>
                <button class='btn' id='toggle-logging'>Enable Logging</button>
                <button class='btn danger' onclick='clearLog()'>Clear Log</button>
                <button class='btn' onclick='downloadLog()'>Download Log</button>
                <button class='btn success' onclick='createNewLog()'>New Log File</button>
            </div>
        </div>
        <div class='config-panel'>
            <h3>⚙️ Configuration</h3>
            <div class='config-form'>
                <div class='form-group'>
                    <label for='config-log-interval'>Logging Interval (ms):</label>
                    <select id='config-log-interval'>
                        <option value='500'>500ms</option>
                        <option value='1000' selected>1 second</option>
                        <option value='2000'>2 seconds</option>
                        <option value='5000'>5 seconds</option>
                        <option value='10000'>10 seconds</option>
                        <option value='30000'>30 seconds</option>
                        <option value='60000'>1 minute</option>
                    </select>
                </div>
                <div class='form-group'>
                    <label for='config-wifi-ssid'>WiFi SSID:</label>
                    <input type='text' id='config-wifi-ssid' placeholder='Enter WiFi SSID' maxlength='31'>
                </div>
                <div class='form-group'>
                    <label for='config-wifi-password'>WiFi Password:</label>
                    <input type='password' id='config-wifi-password' placeholder='Enter WiFi Password' maxlength='63'>
                </div>
            </div>
            <div class='config-buttons'>
                <button class='btn' onclick='loadConfig()'>Load Current</button>
                <button class='btn success' onclick='saveConfig()'>Save Configuration</button>
                <button class='btn warning' onclick='resetConfig()'>Reset to Defaults</button>
                <button class='btn danger' onclick='restartDevice()'>Restart Device</button>
            </div>
        </div>
        <div class='refresh-rate'>
            <label>Refresh Rate: </label>
            <select id='refresh-rate' onchange='updateRefreshRate()'>
                <option value='1000'>1 second</option>
                <option value='2000' selected>2 seconds</option>
                <option value='5000'>5 seconds</option>
                <option value='10000'>10 seconds</option>
            </select>
        </div>
        <div class='timestamp' id='timestamp'>Last updated: --</div>
        <div class='timestamp' id='current-time'>Current time: --</div>
    </div>
    <script>
        let refreshInterval;
        let refreshRate = 2000;
        
        function updateData() {
            fetch('/api/sensor-data')
                .then(response => response.json())
                .then(data => {
                    // Update Sensor 1 data
                    document.getElementById('sensor1-bus-voltage').textContent = data.sensor1.bus_voltage.toFixed(3);
                    document.getElementById('sensor1-shunt-voltage').textContent = data.sensor1.shunt_voltage.toFixed(3);
                    document.getElementById('sensor1-current').textContent = data.sensor1.current.toFixed(3);
                    document.getElementById('sensor1-power').textContent = data.sensor1.power.toFixed(3);
                    document.getElementById('sensor1-raw-bus').textContent = data.sensor1.raw_bus;
                    document.getElementById('sensor1-raw-shunt').textContent = data.sensor1.raw_shunt;
                    document.getElementById('sensor1-raw-current').textContent = data.sensor1.raw_current;
                    document.getElementById('sensor1-raw-power').textContent = data.sensor1.raw_power;
                    
                    // Update Sensor 2 data
                    document.getElementById('sensor2-bus-voltage').textContent = data.sensor2.bus_voltage.toFixed(3);
                    document.getElementById('sensor2-shunt-voltage').textContent = data.sensor2.shunt_voltage.toFixed(3);
                    document.getElementById('sensor2-current').textContent = data.sensor2.current.toFixed(3);
                    document.getElementById('sensor2-power').textContent = data.sensor2.power.toFixed(3);
                    document.getElementById('sensor2-raw-bus').textContent = data.sensor2.raw_bus;
                    document.getElementById('sensor2-raw-shunt').textContent = data.sensor2.raw_shunt;
                    document.getElementById('sensor2-raw-current').textContent = data.sensor2.raw_current;
                    document.getElementById('sensor2-raw-power').textContent = data.sensor2.raw_power;
                    
                    // Update timestamp and status
                    document.getElementById('timestamp').textContent = 'Last updated: ' + new Date(data.timestamp).toLocaleString();
                    document.getElementById('status').textContent = 'Real-time Data (Dual Sensors)';
                    document.getElementById('status').className = 'status connected';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('status').textContent = 'Connection Error';
                    document.getElementById('status').className = 'status error';
                });
        }
        
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 'Current time: ' + now.toLocaleString();
        }
        
        function updateWiFiStatus() {
            fetch('/api/wifi-status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('wifi-status');
                    statusElement.textContent = 'WiFi: ' + data.status;
                    
                    if (data.ap_mode) {
                        statusElement.className = 'status error';
                        statusElement.innerHTML = 'WiFi: ' + data.status + 
                            '<br><small>Connect to: ' + data.ap_ssid + ' (Password: ' + data.ap_password + ')</small>' +
                            '<br><small>Access at: http://' + data.ap_ip + '</small>';
                    } else if (data.status.includes('Connected')) {
                        statusElement.className = 'status connected';
                    } else if (data.status.includes('Failed')) {
                        statusElement.className = 'status error';
                    } else {
                        statusElement.className = 'status';
                    }
                })
                .catch(error => {
                    console.error('Error fetching WiFi status:', error);
                    document.getElementById('wifi-status').textContent = 'WiFi: Status Unknown';
                    document.getElementById('wifi-status').className = 'status error';
                });
        }
        
        function updateLogStatus() {
            fetch('/api/log-status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('log-status').textContent = data.enabled ? 'Enabled' : 'Disabled';
                    document.getElementById('log-filename').textContent = data.filename;
                    document.getElementById('log-size').textContent = (data.size / 1024).toFixed(1) + ' KB';
                    document.getElementById('toggle-logging').textContent = data.enabled ? 'Disable Logging' : 'Enable Logging';
                    document.getElementById('toggle-logging').className = data.enabled ? 'btn danger' : 'btn success';
                })
                .catch(error => console.error('Error fetching log status:', error));
        }
        
        function toggleLogging() {
            const enabled = document.getElementById('log-status').textContent === 'Enabled';
            fetch('/api/log-toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: !enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateLogStatus();
                } else {
                    alert('Failed to toggle logging: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error toggling logging:', error);
                alert('Error toggling logging');
            });
        }
        
        function clearLog() {
            if (confirm('Are you sure you want to clear the log file?')) {
                fetch('/api/log-clear', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateLogStatus();
                        alert('Log cleared successfully');
                    } else {
                        alert('Failed to clear log: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing log:', error);
                    alert('Error clearing log');
                });
            }
        }
        
        function downloadLog() {
            window.open('/api/log-download', '_blank');
        }
        
        function createNewLog() {
            if (confirm('Create a new log file? The current file will be archived.')) {
                fetch('/api/log-new', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateLogStatus();
                        alert('New log file created');
                    } else {
                        alert('Failed to create new log: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error creating new log:', error);
                    alert('Error creating new log');
                });
            }
        }
        
        function loadRefreshRate() {
            fetch('/api/config/refresh-rate')
                .then(response => response.json())
                .then(data => {
                    refreshRate = data.refresh_rate;
                    document.getElementById('refresh-rate').value = refreshRate;
                    clearInterval(refreshInterval);
                    refreshInterval = setInterval(updateData, refreshRate);
                })
                .catch(error => {
                    console.error('Error loading refresh rate:', error);
                    // Use default refresh rate
                    refreshRate = 2000;
                    clearInterval(refreshInterval);
                    refreshInterval = setInterval(updateData, refreshRate);
                });
        }
        
        function updateRefreshRate() {
            refreshRate = parseInt(document.getElementById('refresh-rate').value);
            clearInterval(refreshInterval);
            refreshInterval = setInterval(updateData, refreshRate);
        }
        
        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('config-log-interval').value = data.log_interval_ms;
                    document.getElementById('config-wifi-ssid').value = data.wifi_ssid;
                    document.getElementById('config-wifi-password').value = data.wifi_password;
                    console.log('Configuration loaded');
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                    alert('Failed to load configuration');
                });
        }
        
        function saveConfig() {
            const config = {
                log_interval_ms: parseInt(document.getElementById('config-log-interval').value),
                wifi_ssid: document.getElementById('config-wifi-ssid').value,
                wifi_password: document.getElementById('config-wifi-password').value
            };
            
            // Validate inputs
            if (!config.wifi_ssid.trim()) {
                alert('WiFi SSID cannot be empty');
                return;
            }
            
            if (config.log_interval_ms < 100 || config.log_interval_ms > 60000) {
                alert('Log interval must be between 100ms and 60000ms (1 minute)');
                return;
            }
            
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully! Changes will take effect after restart.');
                    console.log('Configuration saved');
                } else {
                    alert('Failed to save configuration: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving configuration:', error);
                alert('Error saving configuration');
            });
        }
        
        function resetConfig() {
            if (confirm('Reset configuration to defaults? This will clear your WiFi settings.')) {
                document.getElementById('config-log-interval').value = '1000';
                document.getElementById('config-wifi-ssid').value = 'Morties';
                document.getElementById('config-wifi-password').value = 'RickAndRoll';
                console.log('Configuration reset to defaults');
            }
        }
        
        function restartDevice() {
            if (confirm('Are you sure you want to restart the device? This will disconnect you from the web interface.')) {
                fetch('/api/restart', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('Device restart initiated. Please wait a moment and refresh the page.');
                        // Show a countdown or loading message
                        document.getElementById('status').textContent = 'Device restarting...';
                        document.getElementById('status').className = 'status error';
                    } else {
                        alert('Failed to restart device');
                    }
                })
                .catch(error => {
                    console.error('Error restarting device:', error);
                    alert('Error restarting device');
                });
            }
        }
        
        // Initialize
        document.getElementById('toggle-logging').addEventListener('click', toggleLogging);
        updateData();
        updateLogStatus();
        updateWiFiStatus(); // Update WiFi status
        loadRefreshRate(); // Load refresh rate from server
        loadConfig(); // Load configuration from server
        updateCurrentTime(); // Initial time update
        setInterval(updateLogStatus, 10000); // Update log status every 10 seconds
        setInterval(updateWiFiStatus, 5000); // Update WiFi status every 5 seconds
        setInterval(updateCurrentTime, 1000); // Update current time every second
    </script>
</body>
</html>
